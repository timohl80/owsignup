<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
  <title>Stacken.ai ‚Äì Open WebUI Gateway</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
    /* CSS Custom Properties */
    :root {
      --primary-color: #ff6b9d;
      --primary-hover: #ff5a8a;
      --success-color: #28a745;
      --error-color: #dc3545;
      --warning-color: #ffc107;
      --text-primary: #333;
      --text-secondary: #666;
      --text-muted: #999;
      --border-color: #ddd;
      --background-dark: #1a1a1a;
      --background-light: #f0f0f0;
      --border-radius: 8px;
      --border-radius-lg: 12px;
      --spacing-xs: 6px;
      --spacing-sm: 12px;
      --spacing-md: 20px;
      --spacing-lg: 30px;
      --spacing-xl: 40px;
    }

    /* Reset & Base Styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--background-dark);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      padding: var(--spacing-md);
      }
      
    /* Layout Components */
      .container {
        background: white;
      border-radius: var(--border-radius-lg);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      padding: var(--spacing-xl);
        width: 100%;
        max-width: 400px;
      }
      
      .header {
      margin-bottom: var(--spacing-md);
      position: relative;
      }
      
      .logo {
        width: 120px;
        height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
      position: absolute;
      top: -30px;
      left: -30px;
      }
      
      .logo img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      
      .title {
        font-size: 24px;
        font-weight: 600;
      color: var(--text-primary);
      margin: 60px 0 var(--spacing-xs) 0;
      text-align: center;
      }
      
      .subtitle {
      font-size: 12px;
      color: var(--text-secondary);
        line-height: 1.4;
      margin: 0 0 var(--spacing-lg) 0;
      text-align: center;
      }
      
    /* Form Components */
      .form-group {
      margin-bottom: var(--spacing-md);
      }
      
    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 500;
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
      }
      
    .form-input {
        width: 100%;
      padding: var(--spacing-sm) 16px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
        font-size: 14px;
        background: white;
      color: var(--text-primary);
        transition: border-color 0.2s;
      }
      
    .form-input:focus {
        outline: none;
      border-color: var(--primary-color);
      }
      
      .password-container {
        position: relative;
      width: 100%;
    }

    .password-input {
      padding-right: 45px;
      }
      
      .password-toggle {
        position: absolute;
      right: var(--spacing-sm);
      top: 50%;
      transform: translateY(-50%);
        background: none;
        border: none;
        color: #888;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: color 0.2s;
      z-index: 1;
      }
      
      .password-toggle:hover {
      color: var(--primary-color);
    }

    /* Status Components */
      .status {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .status-badge {
      background: var(--background-light);
      color: var(--text-secondary);
      padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
      }
      
    /* Button Components */
    .btn {
        width: 100%;
        border: none;
        padding: 14px;
      border-radius: var(--border-radius);
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
        margin-top: 10px;
      }
      
    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .btn-primary:disabled {
      background: var(--text-secondary);
        cursor: not-allowed;
      }
      
    .btn-success {
      background: var(--success-color);
    }

    .btn-error {
      background: var(--error-color);
    }

    /* Alert Components */
    .alert {
      padding: 15px;
      border-radius: var(--border-radius);
      margin-top: var(--spacing-md);
      border: 1px solid;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border-color: #c3e6cb;
    }

    /* Footer */
      .footer {
        text-align: center;
      margin-top: var(--spacing-lg);
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Tab Components */
    .tabs {
      display: flex;
      margin-bottom: var(--spacing-lg);
      border-bottom: 1px solid var(--border-color);
    }

    .tab {
      flex: 1;
      padding: var(--spacing-sm) var(--spacing-md);
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab:hover {
      color: var(--text-primary);
      background: rgba(0, 0, 0, 0.02);
    }

    .tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
      background: rgba(255, 107, 157, 0.05);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Chatbot Widget Styles */
    .chatbot-widget {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 350px;
      height: 500px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      display: none;
      flex-direction: column;
      z-index: 1000;
      overflow: hidden;
    }

    .chatbot-widget.open {
      display: flex;
    }

    .chatbot-header {
      background: var(--primary-color);
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 12px 12px 0 0;
    }

    .chatbot-title-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chatbot-logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-icon {
      display: flex;
      align-items: flex-end;
      height: 20px;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
      line-height: 1;
    }

    .brand-name {
      font-size: 14px;
      font-weight: 700;
      color: white;
      margin: 0;
    }

    .tagline {
      font-size: 8px;
      color: rgba(255, 255, 255, 0.8);
      margin: 0;
      margin-top: 1px;
    }

    .chatbot-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }

    .chatbot-close {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chatbot-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.4;
    }

    .message.bot {
      background: #f1f5f9;
      color: #334155;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .message.user {
      background: var(--primary-color);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .message.bot a {
      color: var(--primary-color);
      text-decoration: underline;
      font-weight: 500;
      transition: all 0.2s;
      position: relative;
      padding-right: 16px;
    }

    .message.bot a:hover {
      color: var(--primary-hover);
      text-decoration: none;
      transform: translateY(-1px);
    }

    .message.bot a::after {
      content: "‚Üó";
      position: absolute;
      right: 0;
      top: 0;
      font-size: 12px;
      opacity: 0.7;
    }

    .chatbot-input-container {
      padding: 16px 20px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .chatbot-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 24px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    .chatbot-input:focus {
      border-color: var(--primary-color);
    }

    .chatbot-send {
      background: var(--primary-color);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }

    .chatbot-send:hover {
      background: var(--primary-hover);
    }

    .chatbot-send:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .chatbot-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: var(--primary-color);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(255, 107, 157, 0.3);
      transition: all 0.3s;
      z-index: 999;
    }

    .chatbot-toggle:hover {
      background: var(--primary-hover);
      transform: scale(1.05);
    }

    .quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .quick-action {
      background: #e2e8f0;
      border: none;
      padding: 8px 12px;
      border-radius: 16px;
        font-size: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .quick-action:hover {
      background: #cbd5e1;
    }

    /* Utility Classes */
    .hidden {
      display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
    <header class="header">
        <div class="logo">
          <img src="digitalist.svg" alt="Digitalist Logo" width="120" height="120">
        </div>
    </header>

    <main>
        <h1 class="title">Stacken.ai</h1>
        <p class="subtitle">Compliant AI by Digitalist¬©</p>
      
      <!-- Tab Navigation -->
      <div class="tabs">
        <button class="tab active" data-tab="register-tab">Registrera</button>
        <button class="tab" data-tab="login-tab">Logga in</button>
      </div>

      <!-- Registration Tab -->
      <div class="tab-content active" id="register-tab">
        <form id="registrationForm" novalidate>
        <div class="form-group">
          <label for="email" class="form-label">E-post</label>
          <input 
            type="email" 
            id="email" 
            name="email" 
            class="form-input"
            placeholder="namn@f√∂retag.se" 
            required
            autocomplete="email"
          >
        </div>

        <div class="form-group">
          <label for="password" class="form-label">L√∂senord</label>
          <div class="password-container">
            <input 
              type="password" 
              id="password" 
              name="password" 
              class="form-input password-input"
              required
              autocomplete="new-password"
            >
            <button type="button" class="password-toggle" id="passwordToggle" aria-label="Visa/d√∂lj l√∂senord">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Status</label>
          <div class="status">
            <span class="status-badge" id="statusBadge">Ej inbjuden</span>
          </div>
        </div>

        <button type="submit" class="btn btn-primary" id="submitBtn">
          Registrera konto
        </button>
      </form>
      </div>
      
      <!-- Login Tab -->
      <div class="tab-content" id="login-tab">
        <form id="loginForm" novalidate>
          <div class="form-group">
            <label for="loginEmail" class="form-label">E-post</label>
            <input 
              type="email" 
              id="loginEmail" 
              name="email" 
              class="form-input"
              placeholder="namn@f√∂retag.se" 
              required
              autocomplete="email"
            >
          </div>

          <div class="form-group">
            <label for="loginPassword" class="form-label">L√∂senord</label>
            <div class="password-container">
              <input 
                type="password" 
                id="loginPassword" 
                name="password" 
                class="form-input password-input"
                required
                autocomplete="current-password"
              >
              <button type="button" class="password-toggle" id="loginPasswordToggle" aria-label="Visa/d√∂lj l√∂senord">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              </button>
            </div>
          </div>

          <button type="submit" class="btn btn-primary" id="loginBtn">
            Logga in
          </button>
        </form>
      </div>
    </main>

    <footer class="footer">
        Copyright ¬© 2025 Digitalist AB
    </footer>
  </div>

  <!-- Chatbot Widget -->
  <button class="chatbot-toggle" id="chatbotToggle">
    üí¨
  </button>

  <div class="chatbot-widget" id="chatbotWidget">
    <div class="chatbot-header">
      <div class="chatbot-title-container">
        <div class="chatbot-logo">
          <div class="logo-icon">
            <div class="bar" style="height: 12px; width: 3px; background: white; margin-right: 2px;"></div>
            <div class="bar" style="height: 18px; width: 3px; background: white; margin-right: 2px;"></div>
            <div class="bar" style="height: 8px; width: 3px; background: white; margin-right: 2px;"></div>
            <div class="bar" style="height: 4px; width: 3px; background: white;"></div>
          </div>
          <div class="logo-text">
            <div class="brand-name">stacken.</div>
            <div class="tagline">compliant AI by Digitalist¬Æ</div>
          </div>
        </div>
        <h3 class="chatbot-title">Support</h3>
      </div>
      <button class="chatbot-close" id="chatbotClose">√ó</button>
    </div>
    
    <div class="chatbot-messages" id="chatbotMessages">
      <div class="message bot">
        Hej! üëã Jag √§r din AI-assistent f√∂r Stacken.ai support. Jag kan hj√§lpa dig med fr√•gor om registrering, inloggning och allt annat relaterat till v√•r tj√§nst. Vad kan jag hj√§lpa dig med?
        <div class="quick-actions">
          <button class="quick-action" data-question="account">Hur skapar jag ett konto?</button>
          <button class="quick-action" data-question="contact">Vem kontaktar jag?</button>
          <button class="quick-action" data-question="login">Inloggningsproblem</button>
          <button class="quick-action" data-question="approval">Kontogodk√§nnande</button>
        </div>
      </div>
    </div>
    
    <div class="chatbot-input-container">
      <input type="text" class="chatbot-input" id="chatbotInput" placeholder="Skriv ditt meddelande h√§r...">
      <button class="chatbot-send" id="chatbotSend">
        ‚û§
      </button>
      </div>
    </div>

    <script>
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing...');
      
      // Constants
    const SVG_ICONS = {
      eye: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
        <circle cx="12" cy="12" r="3"/>
      </svg>`,
      eyeOff: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
              <line x1="1" y1="1" x2="23" y2="23"/>
      </svg>`
    };

    // DOM Elements
    const elements = {
      // Registration form
      regForm: document.getElementById('registrationForm'),
      regEmailInput: document.getElementById('email'),
      regPasswordInput: document.getElementById('password'),
      regPasswordToggle: document.getElementById('passwordToggle'),
      regSubmitBtn: document.getElementById('submitBtn'),
      statusBadge: document.getElementById('statusBadge'),
      
      // Login form
      loginForm: document.getElementById('loginForm'),
      loginEmailInput: document.getElementById('loginEmail'),
      loginPasswordInput: document.getElementById('loginPassword'),
      loginPasswordToggle: document.getElementById('loginPasswordToggle'),
      loginSubmitBtn: document.getElementById('loginBtn'),
      
      // Tabs
      tabs: document.querySelectorAll('.tab'),
      tabContents: document.querySelectorAll('.tab-content')
    };

    // Tab Switching Functionality
    function switchTab(tabName) {
      // Remove active class from all tabs and content
      elements.tabs.forEach(tab => tab.classList.remove('active'));
      elements.tabContents.forEach(content => content.classList.remove('active'));
      
      // Add active class to selected tab and content
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      document.getElementById(tabName).classList.add('active');
    }

    // Password Toggle Functionality
    function togglePasswordVisibility(inputElement, toggleElement) {
      const isPassword = inputElement.type === 'password';
      
      inputElement.type = isPassword ? 'text' : 'password';
      toggleElement.innerHTML = isPassword ? SVG_ICONS.eyeOff : SVG_ICONS.eye;
    }

    // Form Validation
    function validateForm(emailInput, passwordInput) {
      const email = emailInput.value.trim();
      const password = passwordInput.value;

      if (!email || !password) {
        showError('E-post och l√∂senord kr√§vs');
        return false;
      }

      if (!isValidEmail(email)) {
        showError('Ange en giltig e-postadress');
        return false;
      }

      if (password.length < 6) {
        showError('L√∂senordet m√•ste vara minst 6 tecken');
        return false;
      }

      return true;
    }

    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    // UI State Management
    function setButtonState(button, text, className = 'btn-primary', disabled = false) {
      button.textContent = text;
      button.className = `btn ${className}`;
      button.disabled = disabled;
    }

    function updateStatusBadge(text, className = '') {
      elements.statusBadge.textContent = text;
      elements.statusBadge.className = `status-badge ${className}`;
    }

    function showSuccess(message, button, originalText) {
      setButtonState(button, '‚úì Klar!', 'btn-success', true);
      
      const successAlert = createAlert(message, 'alert-success');
      button.closest('form').appendChild(successAlert);
    }

    function showError(message, button, originalText) {
      setButtonState(button, 'F√∂rs√∂k igen', 'btn-error');
      alert(message);
      
      setTimeout(() => {
        setButtonState(button, originalText, 'btn-primary');
      }, 3000);
    }

    function createAlert(message, className) {
      const alert = document.createElement('div');
      alert.className = `alert ${className}`;
      alert.innerHTML = `<strong>${message}</strong>`;
      return alert;
    }

    // API Communication
    async function registerUser(email, password) {
          const response = await fetch('/api/register', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email, password })
          });
          
      return response.json();
    }

    async function loginUser(email, password) {
      const response = await fetch('/api/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email, password })
      });

      return response.json();
    }

    // Form Submission Handlers
    async function handleRegistrationSubmit(e) {
      console.log('Registration form submitted!');
      e.preventDefault();
      
      if (!validateForm(elements.regEmailInput, elements.regPasswordInput)) {
        console.log('Form validation failed');
        return;
      }
      
      console.log('Form validation passed, proceeding with registration...');

      setButtonState(elements.regSubmitBtn, 'Registrerar...', 'btn-primary', true);
      
      try {
        const result = await registerUser(
          elements.regEmailInput.value.trim(),
          elements.regPasswordInput.value
        );
          
          if (result.success) {
          updateStatusBadge('V√§ntar p√• godk√§nnande', 'status-warning');
          showSuccess(
            'Registrering lyckades!<br>Ditt konto har skapats och v√§ntar p√• godk√§nnande fr√•n en administrat√∂r.',
            elements.regSubmitBtn,
            'Registrera konto'
          );
        } else {
          showError(result.message || 'Registrering misslyckades', elements.regSubmitBtn, 'Registrera konto');
        }
        
      } catch (error) {
        console.error('Registration error:', error);
        showError('Ett fel uppstod. F√∂rs√∂k igen senare.', elements.regSubmitBtn, 'Registrera konto');
      }
    }

    async function handleLoginSubmit(e) {
      console.log('Login form submitted!');
      e.preventDefault();
      
      if (!validateForm(elements.loginEmailInput, elements.loginPasswordInput)) {
        console.log('Form validation failed');
        return;
      }
      
      console.log('Form validation passed, proceeding with login...');

      setButtonState(elements.loginSubmitBtn, 'Loggar in...', 'btn-primary', true);
      
      try {
        const result = await loginUser(
          elements.loginEmailInput.value.trim(),
          elements.loginPasswordInput.value
        );
        
        if (result.success) {
          if (result.demoMode) {
            showSuccess(
              'Inloggning lyckades! (Demo mode)<br>F√∂r att logga in med ditt riktiga konto, starta Open WebUI.',
              elements.loginSubmitBtn,
              'Logga in'
            );
          } else {
            showSuccess(
              'Inloggning lyckades!<br>Omdirigerar till Open WebUI...',
              elements.loginSubmitBtn,
              'Logga in'
            );
            
            // Redirect to Open WebUI after successful login
            setTimeout(() => {
              if (result.token) {
                // Store the token in localStorage for Open WebUI
                localStorage.setItem('access_token', result.token);
                // Redirect to Open WebUI
                window.location.href = result.redirectUrl || '/api/redirect-to-openwebui';
              } else {
                window.location.href = result.redirectUrl || '/api/redirect-to-openwebui';
              }
            }, 2000);
          }
        } else {
          showError(result.message || 'Inloggning misslyckades', elements.loginSubmitBtn, 'Logga in');
          }
          
        } catch (error) {
        console.error('Login error:', error);
        showError('Ett fel uppstod. F√∂rs√∂k igen senare.', elements.loginSubmitBtn, 'Logga in');
      }
    }

    // Event Listeners
    // Tab switching
    console.log('Adding tab event listeners...');
    elements.tabs.forEach((tab, index) => {
      console.log(`Adding listener to tab ${index}:`, tab);
      tab.addEventListener('click', () => {
        const tabName = tab.getAttribute('data-tab');
        console.log('Tab clicked:', tabName);
        switchTab(tabName);
      });
    });

    // Password toggles
    elements.regPasswordToggle.addEventListener('click', () => {
      togglePasswordVisibility(elements.regPasswordInput, elements.regPasswordToggle);
    });
    
    elements.loginPasswordToggle.addEventListener('click', () => {
      togglePasswordVisibility(elements.loginPasswordInput, elements.loginPasswordToggle);
    });

    // Form submissions
    if (elements.regForm) {
      elements.regForm.addEventListener('submit', handleRegistrationSubmit);
      console.log('Registration form event listener added');
    } else {
      console.error('Registration form not found!');
    }
    
    if (elements.loginForm) {
      elements.loginForm.addEventListener('submit', handleLoginSubmit);
      console.log('Login form event listener added');
    } else {
      console.error('Login form not found!');
    }

    // Initialize
    console.log('Registration and login forms initialized');
    console.log('Registration form:', elements.regForm);
    console.log('Login form:', elements.loginForm);
    console.log('Tabs found:', elements.tabs.length);
    console.log('Tab contents found:', elements.tabContents.length);
    
    // Test tab switching
    console.log('Testing tab switching...');
    elements.tabs.forEach((tab, index) => {
      console.log(`Tab ${index}:`, tab, 'data-tab:', tab.getAttribute('data-tab'));
    });
    
    // Test tab switching function
    console.log('Testing switchTab function...');
    try {
      switchTab('login-tab');
      console.log('Switch to login tab successful');
          setTimeout(() => {
        switchTab('register-tab');
        console.log('Switch to register tab successful');
      }, 1000);
    } catch (error) {
      console.error('Tab switching error:', error);
    }
    
    // Chatbot functionality
    const chatbotToggle = document.getElementById('chatbotToggle');
    const chatbotWidget = document.getElementById('chatbotWidget');
    const chatbotClose = document.getElementById('chatbotClose');
    const chatbotMessages = document.getElementById('chatbotMessages');
    const chatbotInput = document.getElementById('chatbotInput');
    const chatbotSend = document.getElementById('chatbotSend');

    // Note: Static responses removed - now using Open WebUI assistant

    // Toggle chatbot
    chatbotToggle.addEventListener('click', function() {
      chatbotWidget.classList.toggle('open');
      if (chatbotWidget.classList.contains('open')) {
        chatbotInput.focus();
      }
    });

    // Close chatbot
    chatbotClose.addEventListener('click', function() {
      chatbotWidget.classList.remove('open');
    });

    // Send message
    function sendMessage(message, isUser = true) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
      
      if (isUser) {
        messageDiv.textContent = message;
      } else {
        // For bot messages, parse URLs and make them clickable
        createMessageWithLinks(messageDiv, message);
      }
      
      chatbotMessages.appendChild(messageDiv);
      chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }

    // Function to create message with clickable links
    function createMessageWithLinks(container, text) {
      // First handle markdown-style links [text](url)
      const markdownRegex = /\[([^\]]+)\]\(([^)]+)\)/g;
      let lastIndex = 0;
      let match;
      
      while ((match = markdownRegex.exec(text)) !== null) {
        // Add text before the link
        if (match.index > lastIndex) {
          const textBefore = text.slice(lastIndex, match.index);
          container.appendChild(document.createTextNode(textBefore));
        }
        
        // Create the link
        const link = document.createElement('a');
        link.href = match[2];
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.textContent = match[1];
        container.appendChild(link);
        
        lastIndex = markdownRegex.lastIndex;
      }
      
      // Add remaining text
      if (lastIndex < text.length) {
        let remainingText = text.slice(lastIndex);
        
        // Handle plain URLs in remaining text
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        let urlMatch;
        let urlLastIndex = 0;
        
        while ((urlMatch = urlRegex.exec(remainingText)) !== null) {
          // Add text before the URL
          if (urlMatch.index > urlLastIndex) {
            const textBefore = remainingText.slice(urlLastIndex, urlMatch.index);
            container.appendChild(document.createTextNode(textBefore));
          }
          
          // Create the URL link
          let cleanUrl = urlMatch[1];
          let trailingPunctuation = '';
          
          // Check if URL ends with punctuation
          if (/[.,!?;:]$/.test(cleanUrl)) {
            trailingPunctuation = cleanUrl.slice(-1);
            cleanUrl = cleanUrl.slice(0, -1);
          }
          
          const link = document.createElement('a');
          link.href = cleanUrl;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.textContent = cleanUrl;
          container.appendChild(link);
          
          // Add trailing punctuation
          if (trailingPunctuation) {
            container.appendChild(document.createTextNode(trailingPunctuation));
          }
          
          urlLastIndex = urlRegex.lastIndex;
        }
        
        // Add remaining text after URLs
        if (urlLastIndex < remainingText.length) {
          container.appendChild(document.createTextNode(remainingText.slice(urlLastIndex)));
        }
      }
    }


    // Add quick actions to message
    function addQuickActions(actions) {
      const quickActionsDiv = document.createElement('div');
      quickActionsDiv.className = 'quick-actions';
      
      actions.forEach(action => {
        const button = document.createElement('button');
        button.className = 'quick-action';
        button.textContent = action.text;
        button.setAttribute('data-question', action.question);
        quickActionsDiv.appendChild(button);
      });
      
      const lastMessage = chatbotMessages.lastElementChild;
      lastMessage.appendChild(quickActionsDiv);
    }

    // Handle quick action clicks
    chatbotMessages.addEventListener('click', function(e) {
      if (e.target.classList.contains('quick-action')) {
        const question = e.target.getAttribute('data-question');
        const questionText = e.target.textContent;
        
        // Send the question text to the assistant
        sendMessage(questionText, true);
        
        // Disable send button while processing
        chatbotSend.disabled = true;
        chatbotSend.textContent = '...';
        
        // Call the Open WebUI assistant
        callOpenWebUIAssistant(questionText);
      }
    });

    // Send button click
    chatbotSend.addEventListener('click', function() {
      const message = chatbotInput.value.trim();
      if (message) {
        sendMessage(message, true);
        chatbotInput.value = '';
        
        // Disable send button while processing
        chatbotSend.disabled = true;
        chatbotSend.textContent = '...';
        
        // Call the Open WebUI assistant
        callOpenWebUIAssistant(message);
      }
    });

    // Function to call Open WebUI assistant
    async function callOpenWebUIAssistant(message) {
      try {
        const response = await fetch('/api/chatbot', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message: message })
        });

        const data = await response.json();
        
        if (data.success) {
          sendMessage(data.response, false);
        } else {
          sendMessage("Jag har tekniska problem just nu. Kontakta support@stacken.ai f√∂r hj√§lp.", false);
        }
      } catch (error) {
        console.error('Chatbot API error:', error);
        sendMessage("Jag kan inte ansluta till supportsystemet just nu. Kontakta support@stacken.ai f√∂r hj√§lp.", false);
      } finally {
        // Re-enable send button
        chatbotSend.disabled = false;
        chatbotSend.textContent = '‚û§';
      }
    }

    // Enter key to send
    chatbotInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        chatbotSend.click();
      }
    });

    }); // End DOMContentLoaded
    </script>
  </body>
</html>